#Update these to suit your needs
$WinPE_x64WorkSpace = "C:\WinPE_x64_OSDWorkSpace"
$MountDir = "C:\WinPE_x64_MountDir"
#remove-item $WinPE_x64WorkSpace -Force

#Default ADK Paths
$ADKPath = "C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit"
$ADKPathPE = "$ADKPath\Windows Preinstallation Environment"



if (Test-Path -Path $ADKPathPE){
    Write-Host "Found ADK PE: $ADKPathPE" -ForegroundColor Green
    $ADKImage = Get-WindowsImage -ImagePath "$ADKPathPE\amd64\en-us\winpe.wim" -Index 1
}
else {
    Write-Host "Did not detect ADK in path $ADKPathPE"
    throw
}
if (!(test-path -path "$WinPE_x64WorkSpace")){New-Item -Path $WinPE_x64WorkSpace -ItemType Directory | Out-Null}
if (!(test-path -path "$MountDir")){New-Item -Path $MountDir -ItemType Directory | Out-Null}


#Mount WinPE Image To create Windows UEFI 2023 CA signed Windows PE boot media
#https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-create-usb-bootable-drive?view=windows-11
Write-Host "Mounting winpe.wim from $ADKPathPE" -ForegroundColor Green
Mount-WindowsImage -Path $MountDir -ImagePath "$ADKPathPE\amd64\en-us\winpe.wim" -Index 1 | out-null

Copy-Item "$MountDir\Windows\Boot\EFI_EX\bootmgr_EX.efi" "$ADKPathPE\amd64\Media\bootmgr.efi" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\EFI_EX\bootmgfw_EX.efi" "$ADKPathPE\amd64\Media\EFI\Boot\bootx64.efi" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\chs_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\chs_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\cht_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\cht_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\jpn_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\jpn_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\kor_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\kor_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\malgun_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\malgun_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\malgunn_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\malgunn_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\meiryo_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\meiryo_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\meiryon_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\meiryon_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\msjh_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\msjh_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\msjhn_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\msjhn_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\msyh_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\msyh_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\msyhn_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\msyhn_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\segmono_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\segmono_boot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\segoe_slboot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\segoe_slboot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\segoen_slboot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\segoen_slboot.ttf" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\Fonts_EX\wgl4_boot_EX.ttf" "$ADKPathPE\amd64\Media\EFI\Microsoft\Boot\Fonts\wgl4_boot.ttf" -Force -Verbose

#To create Windows UEFI 2011 CA signed Windows PE boot media
Copy-Item "$MountDir\Windows\Boot\EFI\bootmgr.efi" "$ADKPathPE\amd64\Media\bootmgr.efi.2011" -Force -Verbose
Copy-Item "$MountDir\Windows\Boot\EFI\bootmgfw.efi" "$ADKPathPE\amd64\Media\EFI\Boot\bootx64.efi.2011" -Force -Verbose

Copy-Item "$ADKPathPE\amd64\Media\bootmgr.efi.2011" "$WinPE_x64WorkSpace\Media\bootmgr.efi" -Force -Verbose
Copy-Item "$ADKPathPE\amd64\Media\EFI\Boot\bootx64.efi.2011" "$WinPE_x64WorkSpace\Media\EFI\Boot\bootx64.efi" -Force -Verbose

Dismount-WindowsImage -Path $MountDir -save


#Create OSDCloud Template - This will build x64 template, no big deal, we'll replace later.
#remove-item C:\ProgramData\OSDCloud\Templates -force
$OSDCloudTemplateName = 'x642'
if ((Get-OSDCloudTemplateNames) -notcontains "$OSDCloudTemplateName"){
    New-OSDCloudTemplate -Name x642 
    
}

#Create the OSDCloud WorkSpace - This will be created based on the template, but we'll replace what we need
New-OSDCloudWorkspace -WorkspacePath $WinPE_x64WorkSpace
#Update-OSDCloudWorkspace -WorkspacePath $WinPE_x64WorkSpace


#Add Modules to a copy of WinPE from ADK
<#
Mount-WindowsImage -Path $MountDir -ImagePath "$WinPE_ARM64WorkSpace\media\sources\boot.wim" -Index 1 | out-null
#Add PS Modules to the Boot Image
write-host "Saving PowerShell Modules to boot.wim" -ForegroundColor Green
Save-Module -Name PowerShellGet -Path "$MountDir\Program Files\WindowsPowerShell\Modules"
Save-Module -Name PackageManagement -Path "$MountDir\Program Files\WindowsPowerShell\Modules"
Save-Module -Name DellBIOSProvider -Path "$MountDir\Program Files\WindowsPowerShell\Modules" -AcceptLicense
Save-Module -name OSD -Path "$MountDir\Program Files\WindowsPowerShell\Modules"

#Add Drivers 
# Add-WindowsDriver -Path "c:\offline" -Driver "c:\test\drivers" -Recurse
if (Test-Path "$WinPE_x64WorkSpace\Drivers"){
    write-host "Adding Drivers from $WinPE_x64WorkSpace\Drivers to boot image" -ForegroundColor Green
    Mount-WindowsImage -Path $MountDir -ImagePath "$WinPE_x64WorkSpace\media\sources\boot.wim" -Index 1 | out-null
    Add-WindowsDriver -Path $MountDir -Driver "$WinPE_x64WorkSpace\Drivers" -Recurse | out-null #This will be a folder of drivers you collect to add to your WinPE... good luck
    Dismount-WindowsImage -Path $MountDir -Save | out-null
    write-host "Adding Drivers Complete" -ForegroundColor Green
}

#>




<# Run the function based on first time, or follow up times.
#Create the USBStick - First time
New-OSDCloudUSB -WorkspacePath $WinPE_x64WorkSpace

#Update (for if you add drivers or modify your boot.wim file, which you'll do when you want to update the PS Modules)
Update-OSDCloudUSB

MakeWinPEMedia /UFD C:\WinPE_arm64 P:
MakeWinPEMedia /UFD C:\WinPe P:
#>
